<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form Customer - Logistik Kita</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/+esm" type="module"></script>
</head>
<body>
  <header><h1>Form Pengiriman Customer</h1></header>

  <main>
    <form id="formPengiriman" class="form-box">
  <input type="text" id="nama_customer" placeholder="Nama Customer" required />
  <input type="text" id="nomor_hp_customer" placeholder="Nomor HP Customer" required />
  <input type="text" id="asal_kirim" placeholder="Asal Kirim" value="Logistik Kita, Mojokerto" required />
  <input type="text" id="tujuan_kirim" placeholder="Tujuan Kirim" required />
  <input type="text" id="nama_barang" placeholder="Nama Barang" required />
  <input type="number" id="berat_kg" placeholder="Berat (kg)" required />
  <input type="number" id="jumlah_koli" placeholder="Jumlah Koli" required />
  <input type="number" id="panjang_cm" placeholder="Panjang (cm)" required />
  <input type="number" id="lebar_cm" placeholder="Lebar (cm)" required />
  <input type="number" id="tinggi_cm" placeholder="Tinggi (cm)" required />

  <select id="layanan" required>
    <option value="">Pilih Layanan</option>
    <option value="reguler">Reguler</option>
    <option value="prioritas">Prioritas</option>
  </select>

  <select id="referral" required>
    <option value="">Gunakan Referral?</option>
    <option value="ya">Ya</option>
    <option value="tidak">Tidak</option>
  </select>

  <input type="text" id="nama_petugas" placeholder="Nama Petugas" required />
  <button type="button" onclick="cekTarif()">Cek Tarif</button>
    </form>

    <div id="popup" class="popup-box hidden"></div>
  </main>

  <footer><p>&copy; 2025 Logistik Kita</p></footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/+esm'

    const supabase = createClient(
      'https://mrghlcedtafomwnznywf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (API key dipotong di sini untuk keamanan)'
    );

    window.cekTarif = async function () {
      const berat = parseFloat(document.getElementById("berat_kg").value);
      let tarif = 0;
      if (berat <= 50) tarif = 125000;
      else if (berat <= 70) tarif = 125000 + (berat - 50) * 2200;
      else if (berat < 100) tarif = 125000 + (berat - 50) * 2500;
      else if (berat >= 100 && berat <= 264) tarif = berat * 1700;
      else tarif = 450000;

      const panjang = parseFloat(document.getElementById("panjang_cm").value);
      const lebar = parseFloat(document.getElementById("lebar_cm").value);
      const tinggi = parseFloat(document.getElementById("tinggi_cm").value);
      const volume = panjang * lebar * tinggi;

      const data = {
        nomor_surat_jalan: "LK/SJ/" + new Date().getTime().toString().slice(-4) + "/" + new Date().toLocaleDateString('id-ID').replace(/\//g, ''),
        tanggal_masuk: new Date().toISOString(),
        nama_customer: document.getElementById("nama_customer").value,
        nomor_hp_customer: document.getElementById("nomor_hp_customer").value,
        asal_kirim: document.getElementById("asal_kirim").value,
        tujuan_kirim: document.getElementById("tujuan_kirim").value,
        nama_barang: document.getElementById("nama_barang").value,
        berat_kg: berat,
        jumlah_koli: parseInt(document.getElementById("jumlah_koli").value),
        panjang_cm: panjang,
        lebar_cm: lebar,
        tinggi_cm: tinggi,
        volume_cm3: volume,
        jenis_armada: "Pickup Granmax",
        layanan: document.getElementById("layanan").value,
        referral: document.getElementById("referral").value,
        nama_petugas: document.getElementById("nama_petugas").value,
        tarif_pengiriman: tarif,
        biaya_bbm: 0,
        biaya_driver: 0,
        biaya_sewa_armada: 0,
        profit_kotor: 0,
        status_kirim: "pending"
      };

      const popup = document.getElementById("popup");
      popup.innerHTML = `
        <h3>Konfirmasi Data</h3>
        <p>Nama: ${data.nama_customer}<br>
           Tujuan: ${data.tujuan_kirim}<br>
           Berat: ${data.berat_kg} kg<br>
           Volume: ${volume.toLocaleString()} cm³<br>
           Tarif: Rp ${tarif.toLocaleString("id-ID")}</p>
        <button onclick='kirimData(${JSON.stringify(JSON.stringify(data))})'>Customer Setuju</button>
      `;
      popup.classList.remove("hidden");
    }

    window.kirimData = async function (dataStr) {
      const data = JSON.parse(dataStr);
      const { error } = await supabase.from("Data_Barang").insert([data]);
      if (error) {
        alert("❌ Gagal kirim data:\n" + error.message);
      } else {
        alert("✅ Data berhasil dikirim!");
        document.getElementById("formPengiriman").reset();
        document.getElementById("popup").classList.add("hidden");
      }
    }
  </script>
</body>
</html>
