<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Pengiriman - Logistik Kita</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/+esm"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: #dc3545; }
    .navbar-brand, .nav-link { color: #fff !important; }
    .filter-box { background: #f8f9fa; padding: 20px; border-radius: 10px; }
    table { margin-top: 20px; }
    .modal-content strong { color: #dc3545; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="admin.html">
        <img src="logo_logistikkita.png" alt="Logo" height="30" class="me-2">
        Logistik Kita - Admin
      </a>
    </div>
  </nav>

  <!-- Filter -->
  <div class="container mt-4">
    <div class="filter-box">
      <div class="row g-2 align-items-end">
        <div class="col-md-5">
          <label>Bulan</label>
          <select id="bulan" class="form-select">
            <option value="01">Januari</option><option value="02">Februari</option>
            <option value="03">Maret</option><option value="04">April</option>
            <option value="05">Mei</option><option value="06">Juni</option>
            <option value="07">Juli</option><option value="08">Agustus</option>
            <option value="09">September</option><option value="10">Oktober</option>
            <option value="11">November</option><option value="12">Desember</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Tahun</label>
          <select id="tahun" class="form-select">
            <script>
              const yNow = new Date().getFullYear();
              for(let y = yNow; y >= yNow - 5; y--) {
                document.write(`<option value="${y}">${y}</option>`);
              }
            </script>
          </select>
        </div>
        <div class="col-md-3">
          <button onclick="tampilkanData()" class="btn btn-danger w-100">Tampilkan</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div id="dataContainer" class="table-responsive d-none">
      <table class="table table-bordered table-striped mt-4">
        <thead class="table-danger">
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Tujuan</th>
            <th>Berat</th>
            <th>Tarif</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tabelData"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Detail -->
  <div class="modal fade" id="modalDetail" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content p-4">
        <h5 class="modal-title mb-3">Detail Pengiriman</h5>
        <div id="isiDetail"></div>
        <div class="mt-3 text-end">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Tutup</button>
          <button class="btn btn-warning" onclick="editData()">Edit</button>
          <button class="btn btn-danger" onclick="hapusData()">Hapus</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      "https://mrghlcedtafomwnznywf.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZ2hsY2VkdGFmb213bnpueXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzMTAwMTcsImV4cCI6MjA2NTg4NjAxN30.vCLC9w8sT0-4uMLFt9c-3BsFeLVco68ajtsu2ZQUiWs"
    );

    let selectedData = null;

    async function tampilkanData() {
      const bulan = document.getElementById("bulan").value;
      const tahun = document.getElementById("tahun").value;
      const { data, error } = await supabase
        .from("Data_Barang")
        .select("*")
        .gte("tanggal_masuk", `${tahun}-${bulan}-01`)
        .lte("tanggal_masuk", `${tahun}-${bulan}-31`)
        .order("tanggal_masuk", { ascending: false });

      const table = document.getElementById("tabelData");
      table.innerHTML = "";
      if (data && data.length) {
        data.forEach((item, i) => {
          const row = `
            <tr>
              <td>${i + 1}</td>
              <td>${item.nama_customer}</td>
              <td>${item.tujuan_kirim}</td>
              <td>${item.berat_kg} kg</td>
              <td>Rp ${item.tarif_pengiriman?.toLocaleString("id-ID")}</td>
              <td><button class="btn btn-sm btn-outline-primary" onclick='showDetail(${JSON.stringify(JSON.stringify(item))})'>Lihat Detail</button></td>
            </tr>
          `;
          table.innerHTML += row;
        });
        document.getElementById("dataContainer").classList.remove("d-none");
      } else {
        table.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Data tidak ditemukan</td></tr>`;
        document.getElementById("dataContainer").classList.remove("d-none");
      }
    }

    function showDetail(dataStr) {
      selectedData = JSON.parse(dataStr);
      const d = selectedData;
      const detailHTML = Object.entries(d).map(([k, v]) => `<p><strong>${k.replace(/_/g, ' ')}:</strong> ${v}</p>`).join("");
      document.getElementById("isiDetail").innerHTML = detailHTML;
      new bootstrap.Modal(document.getElementById("modalDetail")).show();
    }

    function editData() {
      alert("✏️ Edit data belum diaktifkan. Fitur sedang dikembangkan...");
    }

    async function hapusData() {
      if (!confirm("Yakin ingin menghapus data ini?")) return;
      const { error } = await supabase.from("Data_Barang").delete().eq("nomor_surat_jalan", selectedData.nomor_surat_jalan);
      if (error) return alert("❌ Gagal hapus data: " + error.message);
      alert("✅ Data berhasil dihapus");
      tampilkanData();
      bootstrap.Modal.getInstance(document.getElementById("modalDetail")).hide();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
