<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rekap Carter & Grafik - Logistik Kita</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .container { margin-top: 2rem; }
    h1 { color: #ba1a1a; }
    .table-container { max-height: 480px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; background: white; }
    canvas { background: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2rem; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">ðŸ“Š Rekap Carter & Grafik</h1>  <div class="table-container mb-4">
    <table class="table table-striped table-sm">
      <thead class="table-danger">
        <tr>
          <th>Nomor Surat</th>
          <th>Petugas</th>
          <th>Customer</th>
          <th>Barang</th>
          <th>Berat</th>
          <th>Tarif Final</th>
          <th>Profit</th>
          <th>Tanggal</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>
  </div>  <!-- Grafik Section -->  <div class="row">
    <div class="col-md-6">
      <canvas id="chartPendapatan"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartProfit"></canvas>
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-md-6">
      <canvas id="chartArmada"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartCustomer"></canvas>
    </div>
  </div>
</div><script>
const client = window.supabase.createClient(
  "https://mrghlcedtafomwnznywf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFz..."
);

async function loadData() {
  const { data, error } = await client.from("tarif_carter_admin")
    .select("nomor_surat_jalan, nama_petugas, jenis_customer, nama_barang, berat_barang, tarif_final, estimasi_profit, created_at, armada_yang_dipakai")
    .order("created_at", { ascending: false })
    .limit(15);

  if (error) return console.error(error);

  const body = document.getElementById("dataBody");
  body.innerHTML = data.map(row => `
    <tr>
      <td>${row.nomor_surat_jalan}</td>
      <td>${row.nama_petugas}</td>
      <td>${row.jenis_customer}</td>
      <td>${row.nama_barang}</td>
      <td>${row.berat_barang ?? 0} kg</td>
      <td>Rp${(row.tarif_final || 0).toLocaleString()}</td>
      <td>Rp${(row.estimasi_profit || 0).toLocaleString()}</td>
      <td>${new Date(row.created_at).toLocaleDateString()}</td>
    </tr>`).join("");

  renderCharts(data);
}

function renderCharts(rows) {
  const byDate = {};
  const armadaCount = {};
  const customerType = { perorangan: 0, perusahaan: 0 };

  rows.forEach(r => {
    const tgl = new Date(r.created_at).toISOString().slice(0, 10);
    if (!byDate[tgl]) byDate[tgl] = { pendapatan: 0, profit: 0 };
    byDate[tgl].pendapatan += r.tarif_final || 0;
    byDate[tgl].profit += r.estimasi_profit || 0;
    armadaCount[r.armada_yang_dipakai] = (armadaCount[r.armada_yang_dipakai] || 0) + 1;
    if (r.jenis_customer in customerType) customerType[r.jenis_customer]++;
  });

  new Chart(document.getElementById("chartPendapatan"), {
    type: 'bar',
    data: {
      labels: Object.keys(byDate),
      datasets: [{ label: 'Pendapatan', data: Object.values(byDate).map(d => d.pendapatan), backgroundColor: '#ba1a1a' }]
    }
  });

  new Chart(document.getElementById("chartProfit"), {
    type: 'line',
    data: {
      labels: Object.keys(byDate),
      datasets: [{ label: 'Profit', data: Object.values(byDate).map(d => d.profit), borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.1)' }]
    }
  });

  new Chart(document.getElementById("chartArmada"), {
    type: 'doughnut',
    data: {
      labels: Object.keys(armadaCount),
      datasets: [{ label: 'Armada Dipakai', data: Object.values(armadaCount), backgroundColor: ['#ff6384','#36a2eb','#ffcd56','#4bc0c0'] }]
    }
  });

  new Chart(document.getElementById("chartCustomer"), {
    type: 'pie',
    data: {
      labels: Object.keys(customerType),
      datasets: [{ label: 'Tipe Customer', data: Object.values(customerType), backgroundColor: ['#007bff','#ffc107'] }]
    }
  });
}

loadData();
</script></body>
</html>
