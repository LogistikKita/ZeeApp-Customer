<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rekap Carter & Grafik</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 1024px;
      margin-top: 2rem;
      margin-bottom: 4rem;
    }
    h1 {
      color: #ba1a1a;
    }
    th {
      background-color: #fddede;
    }
    canvas {
      background-color: white;
      border-radius: 1rem;
      padding: 1rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="text-center mb-4">
    <h1>ðŸ“Š Rekap Carter & Grafik</h1>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered" id="tabelRekap">
      <thead>
        <tr>
          <th>Nomor Surat</th><th>Petugas</th><th>Customer</th><th>Barang</th><th>Berat</th>
          <th>Tarif Final</th><th>Profit</th><th>Tanggal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>  <div class="row g-4 mt-4">
    <div class="col-md-6"><canvas id="grafikPendapatan"></canvas></div>
    <div class="col-md-6"><canvas id="grafikProfit"></canvas></div>
    <div class="col-md-6"><canvas id="grafikJenisCustomer"></canvas></div>
    <div class="col-md-6"><canvas id="grafikArmada"></canvas></div>
  </div>
</div><script>
const client = window.supabase.createClient(
  "https://mrghlcedtafomwnznywf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZ2hsY2VkdGFmb213bnpueXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzMTAwMTcsImV4cCI6MjA2NTg4NjAxN30.vCLC9w8sT0-4uMLFt9c-3BsFeLVco68ajtsu2ZQUiWs"
);

async function loadData() {
  const { data, error } = await client.from("tarif_carter_admin").select("*").order("jadwal_pengiriman", { ascending: false }).limit(15);
  if (error) return alert("Gagal ambil data: " + error.message);

  const tbody = document.querySelector("#tabelRekap tbody");
  tbody.innerHTML = "";

  const tanggalArr = [], tarifArr = [], profitArr = [], tipeCount = {}, armadaCount = {};

  data.forEach(row => {
    tbody.innerHTML += `
      <tr>
        <td>${row.nomor_surat_jalan}</td>
        <td>${row.nama_petugas}</td>
        <td>${row.jenis_customer}</td>
        <td>${row.nama_barang}</td>
        <td>${row.berat_barang} kg</td>
        <td>Rp${row.tarif_final.toLocaleString()}</td>
        <td>Rp${row.estimasi_profit.toLocaleString()}</td>
        <td>${row.jadwal_pengiriman?.split('T')[0]}</td>
      </tr>`;

    const tanggal = row.jadwal_pengiriman?.split("T")[0];
    tanggalArr.unshift(tanggal);
    tarifArr.unshift(row.tarif_final);
    profitArr.unshift(row.estimasi_profit);
    tipeCount[row.jenis_customer] = (tipeCount[row.jenis_customer] || 0) + 1;
    armadaCount[row.armada_yang_dipakai] = (armadaCount[row.armada_yang_dipakai] || 0) + 1;
  });

  new Chart(grafikPendapatan, {
    type: 'line',
    data: {
      labels: tanggalArr,
      datasets: [{
        label: 'Pendapatan (Tarif Final)',
        data: tarifArr,
        backgroundColor: '#ba1a1a88',
        borderColor: '#ba1a1a',
        fill: true
      }]
    }
  });

  new Chart(grafikProfit, {
    type: 'line',
    data: {
      labels: tanggalArr,
      datasets: [{
        label: 'Estimasi Profit',
        data: profitArr,
        backgroundColor: '#28a74588',
        borderColor: '#28a745',
        fill: true
      }]
    }
  });

  new Chart(grafikJenisCustomer, {
    type: 'pie',
    data: {
      labels: Object.keys(tipeCount),
      datasets: [{
        label: 'Jenis Customer',
        data: Object.values(tipeCount),
        backgroundColor: ['#ffc107','#007bff','#dc3545','#20c997']
      }]
    }
  });

  new Chart(grafikArmada, {
    type: 'doughnut',
    data: {
      labels: Object.keys(armadaCount),
      datasets: [{
        label: 'Armada Digunakan',
        data: Object.values(armadaCount),
        backgroundColor: ['#6f42c1','#fd7e14','#17a2b8','#343a40']
      }]
    }
  });
}

loadData();
</script></body>
</html>
