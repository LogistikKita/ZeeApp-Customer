<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rekap Carter & Grafik Omzet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background: #f5f5f5; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 1280px; margin-top: 2rem; background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h1 { color: #ba1a1a; }
    table th, table td { vertical-align: middle; }
    .summary-box { background: #fff3f3; border-left: 5px solid #ba1a1a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">üìä Rekap Carter & Grafik Omzet</h1>  <div class="row mb-3">
    <div class="col-md-3"><input type="date" class="form-control" id="startDate"></div>
    <div class="col-md-3"><input type="date" class="form-control" id="endDate"></div>
    <div class="col-md-3"><button class="btn btn-danger w-100" onclick="filterTanggal()">üîç Filter Tanggal</button></div>
    <div class="col-md-3"><button class="btn btn-success w-100" onclick="exportExcel()">üì§ Export Excel</button></div>
  </div>  <div class="row">
    <div class="col-md-3 summary-box"><strong>Total Omzet:</strong><div id="totalOmzet">Rp0</div></div>
    <div class="col-md-3 summary-box"><strong>Estimasi Profit:</strong><div id="totalProfit">Rp0</div></div>
    <div class="col-md-3 summary-box"><strong>PPH (0.5%):</strong><div id="totalPph">Rp0</div></div>
    <div class="col-md-3 summary-box"><strong>Total Order:</strong><div id="totalOrder">0</div></div>
  </div>  <div class="table-responsive mt-4">
    <table class="table table-bordered table-striped" id="rekapTable">
      <thead class="table-danger text-center">
        <tr>
          <th>#</th><th>Nomor Surat</th><th>Jadwal</th><th>Customer</th><th>Barang</th>
          <th>Omzet</th><th>Profit</th><th>PPH</th><th>Aksi</th>
        </tr>
      </thead>
      <tbody id="rekapBody"></tbody>
    </table>
  </div><canvas id="grafikOmzet" height="120" class="mt-5"></canvas>

</div><script>
const supabase = window.supabase.createClient(
  "https://mrghlcedtafomwnznywf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZ2hsY2VkdGFmb213bnpueXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzMTAwMTcsImV4cCI6MjA2NTg4NjAxN30.vCLC9w8sT0-4uMLFt9c-3BsFeLVco68ajtsu2ZQUiWs" // Replace with full anon key
);

let fullData = [];

async function loadData() {
  const { data, error } = await supabase.from("tarif_carter_admin").select("*").order("jadwal_pengiriman", { ascending: false });
  if (error) return alert("Gagal mengambil data: " + error.message);
  fullData = data;
  renderTable();
  renderGrafik();
  renderSummary();
}

function renderTable() {
  const tbody = document.getElementById("rekapBody");
  tbody.innerHTML = "";
  const limited = fullData.slice(0, 15);
  limited.forEach((item, i) => {
    const pph = item.tarif_final * 0.005;
    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${item.nomor_surat_jalan}</td>
        <td>${item.jadwal_pengiriman?.slice(0, 10)}</td>
        <td>${item.jenis_customer}</td>
        <td>${item.nama_barang}</td>
        <td>Rp${item.tarif_final.toLocaleString()}</td>
        <td>Rp${item.estimasi_profit.toLocaleString()}</td>
        <td>Rp${Math.round(pph).toLocaleString()}</td>
        <td><button class="btn btn-sm btn-warning" onclick='editData("${item.id}")'>Edit</button>
            <button class="btn btn-sm btn-danger" onclick='hapusData("${item.id}")'>Hapus</button></td>
      </tr>`;
  });
}

function renderSummary() {
  const total = fullData.reduce((sum, d) => sum + d.tarif_final, 0);
  const profit = fullData.reduce((sum, d) => sum + d.estimasi_profit, 0);
  const pph = total * 0.005;
  document.getElementById("totalOmzet").innerText = `Rp${total.toLocaleString()}`;
  document.getElementById("totalProfit").innerText = `Rp${profit.toLocaleString()}`;
  document.getElementById("totalPph").innerText = `Rp${Math.round(pph).toLocaleString()}`;
  document.getElementById("totalOrder").innerText = fullData.length;
}

function renderGrafik() {
  const ctx = document.getElementById("grafikOmzet").getContext("2d");
  const daily = {};
  fullData.forEach(item => {
    const tgl = item.jadwal_pengiriman?.slice(0, 10);
    if (!daily[tgl]) daily[tgl] = 0;
    daily[tgl] += item.tarif_final;
  });
  const labels = Object.keys(daily);
  const data = Object.values(daily);

  new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{
      label: 'Omzet Harian',
      data,
      backgroundColor: '#ba1a1a'
    }] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

function exportExcel() {
  const wb = XLSX.utils.book_new();
  const rows = fullData.map((d, i) => ({
    No: i + 1,
    Nomor_Surat: d.nomor_surat_jalan,
    Jadwal: d.jadwal_pengiriman,
    Customer: d.jenis_customer,
    Barang: d.nama_barang,
    Omzet: d.tarif_final,
    Profit: d.estimasi_profit,
    PPH: Math.round(d.tarif_final * 0.005)
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Rekap Carter");
  XLSX.writeFile(wb, "rekap-carter.xlsx");
}

function filterTanggal() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end) return alert("Pilih rentang tanggal dulu!");
  fullData = fullData.filter(d => d.jadwal_pengiriman >= start && d.jadwal_pengiriman <= end + "T23:59:59");
  renderTable(); renderSummary(); renderGrafik();
}

async function hapusData(id) {
  if (!confirm("Hapus data ini?")) return;
  const { error } = await supabase.from("tarif_carter_admin").delete().eq("id", id);
  if (error) return alert("Gagal hapus: " + error.message);
  alert("Data berhasil dihapus");
  loadData();
}

function editData(id) {
  alert("üöß Fitur edit belum tersedia. Dalam pengembangan!");
}

loadData();
</script></body>
</html>
